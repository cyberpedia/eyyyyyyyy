# NGINX Ingress Controller rate-limiting for CTF backend
# Note: Requires allowing server-snippet/configuration-snippet in your controller config.
# For managed environments that restrict snippets, prefer globally-enabled limit-rps/burst
# or a sidecar limiter. This template applies per-IP limits at the edge and complements
# app-level throttles in the Django API.

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ctf-backend
  namespace: ctf
  annotations:
    kubernetes.io/ingress.class: "nginx"
    # Define two zones (per IP): login and submit
    nginx.ingress.kubernetes.io/server-snippet: |
      limit_req_zone $binary_remote_addr zone=login_zone:10m rate=5r/m;
      limit_req_zone $binary_remote_addr zone=submit_zone:10m rate=10r/m;
    # Default cap for all API requests (optional)
    nginx.ingress.kubernetes.io/limit-rps: "20"
    nginx.ingress.kubernetes.io/limit-burst: "40"
    nginx.ingress.kubernetes.io/proxy-body-size: "8m"
spec:
  rules:
    - host: api.example-ctf.com
      http:
        paths:
          - path: /api/
            pathType: Prefix
            backend:
              service:
                name: ctf-backend
                port:
                  number: 8000
          # Apply stricter limits for login
          - path: /api/auth/login
            pathType: Exact
            backend:
              service:
                name: ctf-backend
                port:
                  number: 8000
            # Per-location config to bind login zone
            # Burst allows brief spikes; adjust to taste
            annotations:
              nginx.ingress.kubernetes.io/configuration-snippet: |
                limit_req zone=login_zone burst=5 nodelay;
          # Apply stricter limits for flag submission
          - path: /api/challenges/.*/submit
            pathType: ImplementationSpecific
            backend:
              service:
                name: ctf-backend
                port:
                  number: 8000
            annotations:
              nginx.ingress.kubernetes.io/configuration-snippet: |
                limit_req zone=submit_zone burst=20 nodelay;